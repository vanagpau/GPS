---
title: "GPS_age"
author: "Jo Cutler"
date: "20/05/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

knitr::opts_chunk$set(echo = TRUE)
options(digits = 4)

# load required packages and functions

require(pacman)
pacman::p_load(car,
               cowplot,
               effectsize,
               ggtext,
               GPArotation, 
               haven,
               Hmisc,
               irr,
               kableExtra,
               lavaan,
               lemon,
               lme4, 
               lmerTest,
               mediation,
               parameters, 
               psych,
               scales,
               see,
               tidyverse
)
```

```{r results = "asis"}

df <- read_dta("individual_new.dta") 
df<- df %>% 
  mutate(gender = factor(gender,
                      levels = c(0,1),
                      labels = c("male", "female")))
df$age.r <- df$age
df$age <- scale(df$age)

resolution <- 300
plotW <- 4
plotH <- 4

axtext <- 16
axtitle <- 20
dotcols <- c("#A363D9")
pos.corr.col <- "#CA4640" 
neg.corr.col <-  "#00A7DD"

vars <- c("posrecip", "negrecip", "altruism", "trust")
var.labs <- c("Positive reciprocity", "Negative reciprocity", "Altruism", "Trust")

for (v in 1:length(vars)) {
  
  var <- vars[v]
  var.lab <- var.labs[v]
  
  plot.age <- ggplot(df, aes(x = age.r, y = get(var))) + 
    geom_point(color = dotcols[1], shape = 21, fill = NA, alpha = 0.01, size = 1, show.legend = FALSE) + 
    geom_smooth(color = dotcols[1], fill = dotcols[1], linetype = "solid", method = "lm", formula = y ~ poly(x,2), alpha = 0.3, size = 0.75, show.legend = FALSE) + 
    scale_x_continuous(name = "Age") +
    scale_y_continuous(name = var.lab) + 
    theme_classic() + 
    theme(axis.text = element_markdown(size = axtext),
          axis.title.x = element_markdown(size = axtitle),
          axis.title.y = element_markdown(size = axtitle))
  
  print(plot.age)
  
  df.mod <- df %>% 
    dplyr::rename("outcome" = paste(var)) %>% 
    drop_na(c("outcome","age"))
  
  model.age <- lmer(outcome ~ gender + poly(age,2) + (1 | country) + (0 + age | country), data = df.mod, control = lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))
  
  results.age <- model_parameters(model.age, df_method = "satterthwaite", standardize = "refit")

  table.age <- kable(results.age) %>% kable_styling()
  print(table.age)
  cat("\n")
  
}

```

## Quantification of effects in each country & map plots

```{r fig.align="center", fig.width=10, fig.height=8}

# cntry.list <- read.csv("List_countries.csv", sep = ",", header = TRUE) # list of countries
cntry.list <- df %>% 
  select(c("isocode", "country"))
cntry.list <- unique(cntry.list)

# create a dataframe with the country information and columns of NA to fill in below
countrycols <- c("code", "region", "posrecip", "negrecip", "altruism", "trust", "n")
# country.results <- data.frame(cntry.list$ISO3, cntry.list$Map.Name, matrix(data = NA, nrow = nrow(cntry.list), ncol = (length(countrycols) - 2)))
country.results <- data.frame(cntry.list$isocode, cntry.list$country, matrix(data = NA, nrow = length(cntry.list), ncol = (length(countrycols) - 2)))
names(country.results) <- countrycols
country.results.p <- country.results[,1:6]

# loop over each country
for (c in country.results$code) {
  
  cdf <- subset(df, isocode == c) # select rows from that country
  
  # standardise variables
  cdf[,c("age", "posrecip", "negrecip", "altruism", "trust")] <- scale(cdf[,c("age", "posrecip", "negrecip", "altruism", "trust")])
  
  # run linear model for each outcome & extract parameters
  cntry.p <- model_parameters(lm(posrecip ~ gender + age, data = cdf), standardize = "refit")
  cntry.n <- model_parameters(lm(negrecip ~ gender + age, data = cdf), standardize = "refit")
  cntry.a <- model_parameters(lm(altruism ~ gender + age, data = cdf), standardize = "refit")
  cntry.t <- model_parameters(lm(trust ~ gender + age, data = cdf), standardize = "refit")
  country.results[country.results$code == c, 3:6] = c(tail(cntry.p$Coefficient,1),
                                                      tail(cntry.n$Coefficient,1), 
                                                      tail(cntry.a$Coefficient,1),
                                                      tail(cntry.t$Coefficient,1))
  country.results.p[country.results.p$code == c, 3:6] = c(tail(cntry.p$p,1),
                                                          tail(cntry.n$p,1), 
                                                          tail(cntry.a$p,1), 
                                                          tail(cntry.t$p,1))
  country.results$n[country.results$code == c] = nrow(cdf)

}

country.results.all <- country.results

# # select countries with more than 450 participants
# country.results.p <- country.results.p[country.results$n > 450, ]
# country.results <- country.results[country.results$n > 450, ]
# 
# # find countries with significant effects for each outcome
# age.sig.d <- country.results[country.results.p$distancing < 0.05,]
# age.notsig.d <- country.results[country.results.p$distancing >= 0.05,]
# age.sig.n <- country.results[country.results.p$negrecip < 0.05,]
# age.notsig.n <- country.results[country.results.p$negrecip >= 0.05,]
# age.sig.i <- country.results[country.results.p$internegrecip < 0.05,]
# age.notsig.i <- country.results[country.results.p$internegrecip >= 0.05,]
# age.sig.b <- country.results[country.results.p$bias < 0.05,]
# age.notsig.b <- country.results[country.results.p$bias >= 0.05,]
# 
# country.results$region <- as.character(country.results$region)
# country.results$code <- as.character(country.results$code)

# create data for map
world_map <- map_data("world") %>% 
  subset(region != "Antarctica")

# # select countries in dataset
# continents <- df %>% 
#   select("isocode", "Continent") %>% 
#   distinct()
# names(continents) <- c("code", "continent")
# continents$code <- as.character(continents$code)
# 
# # combine country information with results & add European countries no data collected in to show blank on map
# continents <- left_join(continents, country.results, by = "code") %>% 
#   add_row(region = c("Cyprus", "Czech Republic", "Estonia", "Lithuania", "Luxembourg", "Malta", "Portugal", "Belarus", "Moldova", "Slovenia", "Bosnia and Herzegovina", "Montenegro", "Kosovo", "Albania", "Bulgaria"), continent = rep("Europe", 15))
df.world <- left_join(world_map, country.results, by = "region")
# df.europe <- subset(df.world, continent == "Europe" & region != "Russia")

# create a map figure for each outcome (distancing, negrecip giving, and internegrecip giving)

world.posrecip <- ggplot(df.world, aes(long, lat, group = group)) +
  geom_polygon(aes(fill = posrecip), color = "white", size = .1) +
   scale_fill_gradient2(low = neg.corr.col, mid = "white", high = pos.corr.col, midpoint = 0, na.value = "#ECECEC", name = expression(beta)) +
  theme_void() +
  draw_plot_label("Positive reciprocity", x = -180, y = -10, hjust = 0, vjust = 0, angle = 90, size = axtitle, fontface = "plain")

# europe.posrecip <- ggplot(df.europe, aes(long, lat, group = group)) +
#   geom_polygon(aes(fill = distancing), color = "white", size = .1) +
#   scale_fill_gradientn(colours = col2(200), limits = c(-.28, .28), breaks = c(-0.2, 0, 0.2), na.value = "#ECECEC", name = expression(beta)) +
#   theme_void() +
#   guides(fill = guide_colorbar(title.hjust = 0.05)) + 
#   theme(legend.text = element_text(size = axtext),
#         legend.title = element_text(size = axtitle))

world.negrecip <- ggplot(df.world, aes(long, lat, group = group)) +
  geom_polygon(aes(fill = negrecip), color = "white", size = .1) +
  scale_fill_gradient2(low = neg.corr.col, mid = "white", high = pos.corr.col, midpoint = 0, na.value = "#ECECEC", name = expression(beta)) +
  theme_void() +
  draw_plot_label("Negative reciprocity", x = -180, y = -20, hjust = 0, vjust = 0, angle = 90, size = axtitle, fontface = "plain")

# europe.negrecip <- ggplot(df.europe, aes(long, lat, group = group)) +
#   geom_polygon(aes(fill = negrecip), color = "white", size = .1) +
#   scale_fill_gradientn(colours = col2(200), limits = c(-.28, .28), breaks = c(-0.2, 0, 0.2), na.value = "#ECECEC", name = expression(beta)) +
#   theme_void() +
#   guides(fill = guide_colorbar(title.hjust = 0.05)) + 
#   theme(legend.text = element_text(size = axtext),
#         legend.title = element_text(size = axtitle))

world.altruism <- ggplot(df.world, aes(long, lat, group = group)) +
  geom_polygon(aes(fill = altruism), color = "white", size = .1) +
    scale_fill_gradient2(low = neg.corr.col, mid = "white", high = pos.corr.col, midpoint = 0, na.value = "#ECECEC", name = expression(beta)) +
  theme_void() +
  draw_plot_label("Altruism", x = -180, y = -35, hjust = 0, vjust = 0, angle = 90, size = axtitle, fontface = "plain")

# europe.inter <- ggplot(df.europe, aes(long, lat, group = group)) +
#   geom_polygon(aes(fill = altruism), color = "white", size = .1) +
#   scale_fill_gradientn(colours = col2(200), limits = c(-.28, .28), breaks = c(-0.2, 0, 0.2), na.value = "#ECECEC", name = expression(beta)) +
#   theme_void() +
#   guides(fill = guide_colorbar(title.hjust = 0.05)) + 
#   theme(legend.text = element_text(size = axtext),
#         legend.title = element_text(size = axtitle))

world.trust <- ggplot(df.world, aes(long, lat, group = group)) +
  geom_polygon(aes(fill = trust), color = "white", size = .1) +
    scale_fill_gradient2(low = neg.corr.col, mid = "white", high = pos.corr.col, midpoint = 0, na.value = "#ECECEC", name = expression(beta)) +
  theme_void() +
  draw_plot_label("Trust", x = -180, y = -35, hjust = 0, vjust = 0, angle = 90, size = axtitle, fontface = "plain")

# europe.trust

plots.map <- plot_grid(world.posrecip, world.negrecip, world.altruism, world.trust, 
                       align = "v", nrow = 2, labels = c("a", "", "b", "", "c", ""), label_size = axtitle-4)
print(plots.map) 

```


## Simple visualisation
```{r}
df.mod %>% ggplot(aes(x = age.r, y = altruism))+ 
    geom_point(
        color="orange",
        fill="#69b3a2",
        shape=21,
        alpha=0.05,
        size=1,
        stroke = 2
        )



```